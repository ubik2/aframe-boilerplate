<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello, World! - A-Frame</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.3.2/aframe.min.js"></script>
    <script src="https://rawgit.com/donmccurdy/aframe-keyboard-controls/master/dist/aframe-keyboard-controls.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  </head>
  <body>
    <a-scene id="scene">
      <a-entity id="player" camera keyboard-controls position="0 0.5 0.5"></a-entity>
      <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>

  AFRAME.registerComponent('network', {
    schema: {},
    update: {},
    remove: {}
  })

  var sceneEl = document.querySelector('a-scene')

  var chat = io.connect('http://192.168.10.17:4000/chat')
  chat.on('connect', function () {
    chat.emit('spawn', { 'position': {x: -1, y: 0.5, z: -3},
                         'rotation': {x: 0, y: 45, z: 0},
                         'color': "#4CC3D9" })
    // hook up to camera position changes to notify the server
    var playerEntityEl = sceneEl.querySelector("#player")
    playerEntityEl.addEventListener('componentchanged', function (evt) {
      if (evt.detail.name === 'position') {
        var oldData = evt.detail.oldData
        var newData = evt.detail.newData
        if (oldData.x !== newData.x || oldData.y !== newData.y || oldData.z !== newData.z) {
          chat.emit('position', evt.detail.newData)
        }
      }
    })
  }).on('message', function (data) {
    console.log(data)
  }).on('spawn', function (data) {
    var entityEl = document.createElement('a-box')
    entityEl.id = data['id']
    entityEl.setAttribute('position', data['position'])
    entityEl.setAttribute('rotation', data['rotation'])
    //entityEl.setAttribute('color', data['color'])
    sceneEl.appendChild(entityEl)
  }).on('despawn', function (data) {
    var entityEl = sceneEl.querySelector('#' + data['id'])
    entityEl.parentNode.removeChild(entityEl);
  }).on('position', function (data) {
    var entityEl = sceneEl.querySelector('#' + data['id'])
    entityEl.setAttribute('position', data['position'])
    sceneEl.appendChild(entityEl)
  })

    </script>
  </body>
</html>
